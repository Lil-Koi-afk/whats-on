// ===== Translations =====
const translations = {
    en: {
        hero_title: "Discover what's happening around you",
        hero_subtitle: "Find festivals, concerts, markets, and local events anywhere in the world",
        where: "Where",
        search_placeholder: "Search cities, regions, islands...",
        radius: "Radius",
        exact: "Exact",
        when: "When",
        search: "Search",
        explore: "Explore",
        about: "About",
        price: "Price:",
        duration: "Duration:",
        price_free: "Free",
        half_day: "Half day",
        full_day: "Full day",
        cat_all: "All Events",
        cat_festivals: "Festivals",
        cat_concerts: "Concerts",
        cat_markets: "Markets",
        cat_sports: "Sports",
        cat_culture: "Culture",
        cat_nightlife: "Nightlife",
        cat_food: "Food & Drink",
        cat_family: "Family",
        cat_outdoor: "Outdoor",
        popular_destinations: "Popular Destinations",
        events: "Events",
        discovering: "Discovering events...",
        things_anytime: "Things to do anytime",
        no_events: "No events found",
        try_adjusting: "Try adjusting your search criteria or expanding the radius",
        footer_tagline: "Discover local events worldwide",
        privacy: "Privacy",
        terms: "Terms",
        more_info: "More info",
        tickets: "Tickets",
        all_day: "All day",
        morning: "Morning",
        afternoon: "Afternoon",
        evening: "Evening",
        night: "Night",
        clear: "Clear dates",
        apply: "Apply",
        select_dates: "Select dates",
        weekdays: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
        months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
    },
    de: {
        hero_title: "Entdecke was um dich herum passiert",
        hero_subtitle: "Finde Festivals, Konzerte, MÃ¤rkte und lokale Events Ã¼berall auf der Welt",
        where: "Wo",
        search_placeholder: "Suche StÃ¤dte, Regionen, Inseln...",
        radius: "Radius",
        exact: "Genau",
        when: "Wann",
        search: "Suchen",
        explore: "Entdecken",
        about: "Ãœber uns",
        price: "Preis:",
        duration: "Dauer:",
        price_free: "Kostenlos",
        half_day: "Halber Tag",
        full_day: "Ganzer Tag",
        cat_all: "Alle Events",
        cat_festivals: "Festivals",
        cat_concerts: "Konzerte",
        cat_markets: "MÃ¤rkte",
        cat_sports: "Sport",
        cat_culture: "Kultur",
        cat_nightlife: "Nachtleben",
        cat_food: "Essen & Trinken",
        cat_family: "Familie",
        cat_outdoor: "Outdoor",
        popular_destinations: "Beliebte Reiseziele",
        events: "Events",
        discovering: "Entdecke Events...",
        things_anytime: "AktivitÃ¤ten fÃ¼r jederzeit",
        no_events: "Keine Events gefunden",
        try_adjusting: "Versuche deine Suchkriterien anzupassen oder den Radius zu erweitern",
        footer_tagline: "Entdecke lokale Events weltweit",
        privacy: "Datenschutz",
        terms: "AGB",
        more_info: "Mehr Info",
        tickets: "Tickets",
        all_day: "GanztÃ¤gig",
        morning: "Vormittag",
        afternoon: "Nachmittag",
        evening: "Abend",
        night: "Nacht",
        clear: "LÃ¶schen",
        apply: "Anwenden",
        select_dates: "Datum wÃ¤hlen",
        weekdays: ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"],
        months: ["Januar", "Februar", "MÃ¤rz", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Dezember"]
    },
    es: {
        hero_title: "Descubre quÃ© estÃ¡ pasando a tu alrededor",
        hero_subtitle: "Encuentra festivales, conciertos, mercados y eventos locales en cualquier parte del mundo",
        where: "DÃ³nde",
        search_placeholder: "Buscar ciudades, regiones, islas...",
        radius: "Radio",
        exact: "Exacto",
        when: "CuÃ¡ndo",
        search: "Buscar",
        explore: "Explorar",
        about: "Acerca de",
        price: "Precio:",
        duration: "DuraciÃ³n:",
        price_free: "Gratis",
        half_day: "Medio dÃ­a",
        full_day: "DÃ­a completo",
        cat_all: "Todos",
        cat_festivals: "Festivales",
        cat_concerts: "Conciertos",
        cat_markets: "Mercados",
        cat_sports: "Deportes",
        cat_culture: "Cultura",
        cat_nightlife: "Vida nocturna",
        cat_food: "Comida y Bebida",
        cat_family: "Familia",
        cat_outdoor: "Al aire libre",
        popular_destinations: "Destinos Populares",
        events: "Eventos",
        discovering: "Descubriendo eventos...",
        things_anytime: "Cosas para hacer en cualquier momento",
        no_events: "No se encontraron eventos",
        try_adjusting: "Intenta ajustar tus criterios de bÃºsqueda o ampliar el radio",
        footer_tagline: "Descubre eventos locales en todo el mundo",
        privacy: "Privacidad",
        terms: "TÃ©rminos",
        more_info: "MÃ¡s info",
        tickets: "Entradas",
        all_day: "Todo el dÃ­a",
        morning: "MaÃ±ana",
        afternoon: "Tarde",
        evening: "Noche",
        night: "Noche",
        clear: "Borrar",
        apply: "Aplicar",
        select_dates: "Seleccionar fechas",
        weekdays: ["Do", "Lu", "Ma", "Mi", "Ju", "Vi", "SÃ¡"],
        months: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]
    },
    it: {
        hero_title: "Scopri cosa succede intorno a te",
        hero_subtitle: "Trova festival, concerti, mercati ed eventi locali ovunque nel mondo",
        where: "Dove",
        search_placeholder: "Cerca cittÃ , regioni, isole...",
        radius: "Raggio",
        exact: "Esatto",
        when: "Quando",
        search: "Cerca",
        explore: "Esplora",
        about: "Chi siamo",
        price: "Prezzo:",
        duration: "Durata:",
        price_free: "Gratis",
        half_day: "Mezza giornata",
        full_day: "Giornata intera",
        cat_all: "Tutti",
        cat_festivals: "Festival",
        cat_concerts: "Concerti",
        cat_markets: "Mercati",
        cat_sports: "Sport",
        cat_culture: "Cultura",
        cat_nightlife: "Vita notturna",
        cat_food: "Cibo e Bevande",
        cat_family: "Famiglia",
        cat_outdoor: "All'aperto",
        popular_destinations: "Destinazioni Popolari",
        events: "Eventi",
        discovering: "Scoprendo eventi...",
        things_anytime: "Cose da fare in qualsiasi momento",
        no_events: "Nessun evento trovato",
        try_adjusting: "Prova a modificare i criteri di ricerca o ad ampliare il raggio",
        footer_tagline: "Scopri eventi locali in tutto il mondo",
        privacy: "Privacy",
        terms: "Termini",
        more_info: "PiÃ¹ info",
        tickets: "Biglietti",
        all_day: "Tutto il giorno",
        morning: "Mattina",
        afternoon: "Pomeriggio",
        evening: "Sera",
        night: "Notte",
        clear: "Cancella",
        apply: "Applica",
        select_dates: "Seleziona date",
        weekdays: ["Do", "Lu", "Ma", "Me", "Gi", "Ve", "Sa"],
        months: ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"]
    }
};

// ===== DOM Elements =====
const locationInput = document.getElementById('location-input');
const radiusSelect = document.getElementById('radius-select');
const dateStart = document.getElementById('date-start');
const dateEnd = document.getElementById('date-end');
const dateField = document.getElementById('date-field');
const dateDisplay = document.getElementById('date-display');
const dateDisplayText = document.getElementById('date-display-text');
const calendarPopup = document.getElementById('calendar-popup');
const calendarOverlay = document.getElementById('calendar-overlay');
const prevMonthBtn = document.getElementById('prev-month');
const nextMonthBtn = document.getElementById('next-month');
const monthTitle1 = document.getElementById('month-title-1');
const monthTitle2 = document.getElementById('month-title-2');
const calendar1 = document.getElementById('calendar-1');
const calendar2 = document.getElementById('calendar-2');
const calendarClear = document.getElementById('calendar-clear');
const calendarApply = document.getElementById('calendar-apply');
const searchBtn = document.getElementById('search-btn');
const resultsSection = document.getElementById('results-section');
const resultsTitle = document.getElementById('results-title');
const resultsSubtitle = document.getElementById('results-subtitle');
const eventsGrid = document.getElementById('events-grid');
const activitiesGrid = document.getElementById('activities-grid');
const activitiesDivider = document.getElementById('activities-divider');
const loadingContainer = document.getElementById('loading');
const emptyState = document.getElementById('empty-state');
const categoryPills = document.querySelectorAll('.category-pill');
const pricePills = document.querySelectorAll('.filter-pill[data-price]');
const durationPills = document.querySelectorAll('.filter-pill[data-duration]');
const popularCards = document.querySelectorAll('.popular-card');
const popularSection = document.getElementById('popular-section');
const languageBtn = document.getElementById('language-btn');
const languageDropdown = document.getElementById('language-dropdown');
const languageOptions = document.querySelectorAll('.language-option');
const currentLangSpan = document.getElementById('current-lang');
const currentFlagSpan = document.getElementById('current-flag');

// ===== State =====
let currentCategory = 'all';
let currentPriceFilters = [];
let currentDurationFilters = [];
let currentLanguage = localStorage.getItem('language') || 'en';

// Calendar state
let calendarCurrentMonth = new Date();
let selectedStartDate = null;
let selectedEndDate = null;
let isSelectingEndDate = false;

// ===== Initialize =====
document.addEventListener('DOMContentLoaded', () => {
    // Set default dates
    const today = new Date();
    const nextWeek = new Date(today);
    nextWeek.setDate(nextWeek.getDate() + 7);
    
    selectedStartDate = today;
    selectedEndDate = nextWeek;
    dateStart.value = formatDate(today);
    dateEnd.value = formatDate(nextWeek);
    updateDateDisplay();
    
    // Apply saved language
    applyLanguage(currentLanguage);
    
    // Event listeners
    searchBtn.addEventListener('click', performSearch);
    
    locationInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') performSearch();
    });
    
    // Calendar event listeners
    dateDisplay.addEventListener('click', (e) => {
        e.stopPropagation();
        calendarPopup.classList.toggle('open');
        calendarOverlay.classList.toggle('open');
        if (calendarPopup.classList.contains('open')) {
            renderCalendars();
        }
    });

    calendarOverlay.addEventListener('click', () => {
        calendarPopup.classList.remove('open');
        calendarOverlay.classList.remove('open');
    });

    prevMonthBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        calendarCurrentMonth.setMonth(calendarCurrentMonth.getMonth() - 1);
        renderCalendars();
    });

    nextMonthBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        calendarCurrentMonth.setMonth(calendarCurrentMonth.getMonth() + 1);
        renderCalendars();
    });

    calendarClear.addEventListener('click', (e) => {
        e.stopPropagation();
        selectedStartDate = null;
        selectedEndDate = null;
        isSelectingEndDate = false;
        dateStart.value = '';
        dateEnd.value = '';
        dateDisplayText.textContent = t('select_dates');
        renderCalendars();
    });

    calendarApply.addEventListener('click', (e) => {
        e.stopPropagation();
        calendarPopup.classList.remove('open');
        calendarOverlay.classList.remove('open');
        updateDateDisplay();
    });

    document.addEventListener('click', (e) => {
        if (!calendarPopup.contains(e.target) && !dateDisplay.contains(e.target)) {
            calendarPopup.classList.remove('open');
            calendarOverlay.classList.remove('open');
        }
    });
    
    // Category filter
    categoryPills.forEach(pill => {
        pill.addEventListener('click', () => {
            categoryPills.forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
            currentCategory = pill.dataset.category;
            
            if (resultsSection.classList.contains('visible') && locationInput.value) {
                performSearch();
            }
        });
    });
    
    // Price filter (multi-select)
    pricePills.forEach(pill => {
        pill.addEventListener('click', () => {
            pill.classList.toggle('active');
            const price = pill.dataset.price;
            
            if (pill.classList.contains('active')) {
                if (!currentPriceFilters.includes(price)) {
                    currentPriceFilters.push(price);
                }
            } else {
                currentPriceFilters = currentPriceFilters.filter(p => p !== price);
            }
            
            if (resultsSection.classList.contains('visible') && locationInput.value) {
                performSearch();
            }
        });
    });

    // Duration filter (multi-select)
    durationPills.forEach(pill => {
        pill.addEventListener('click', () => {
            pill.classList.toggle('active');
            const duration = pill.dataset.duration;
            
            if (pill.classList.contains('active')) {
                if (!currentDurationFilters.includes(duration)) {
                    currentDurationFilters.push(duration);
                }
            } else {
                currentDurationFilters = currentDurationFilters.filter(d => d !== duration);
            }
            
            if (resultsSection.classList.contains('visible') && locationInput.value) {
                performSearch();
            }
        });
    });
    
    // Popular city cards
    popularCards.forEach(card => {
        card.addEventListener('click', () => {
            locationInput.value = card.dataset.city;
            performSearch();
        });
    });
    
    // Language selector
    languageBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        languageDropdown.classList.toggle('open');
    });
    
    document.addEventListener('click', () => {
        languageDropdown.classList.remove('open');
    });
    
    languageOptions.forEach(option => {
        option.addEventListener('click', () => {
            const lang = option.dataset.lang;
            const flag = option.dataset.flag;
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            applyLanguage(lang);
            currentFlagSpan.textContent = flag;
            languageDropdown.classList.remove('open');
            updateDateDisplay();
            
            // Re-search if results visible
            if (resultsSection.classList.contains('visible') && locationInput.value) {
                performSearch();
            }
        });
    });
});

// ===== Calendar Functions =====
function renderCalendars() {
    const month1 = new Date(calendarCurrentMonth);
    const month2 = new Date(calendarCurrentMonth);
    month2.setMonth(month2.getMonth() + 1);

    const months = translations[currentLanguage].months;
    monthTitle1.textContent = `${months[month1.getMonth()]} ${month1.getFullYear()}`;
    monthTitle2.textContent = `${months[month2.getMonth()]} ${month2.getFullYear()}`;

    renderMonth(calendar1, month1);
    renderMonth(calendar2, month2);
}

function renderMonth(container, date) {
    const weekdays = translations[currentLanguage].weekdays;
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    let html = '<div class="calendar-weekdays">';
    weekdays.forEach(day => {
        html += `<div class="calendar-weekday">${day}</div>`;
    });
    html += '</div><div class="calendar-days">';

    // Empty cells before first day
    for (let i = 0; i < firstDay.getDay(); i++) {
        html += '<button class="calendar-day empty"></button>';
    }

    // Days of month
    for (let day = 1; day <= lastDay.getDate(); day++) {
        const currentDate = new Date(year, month, day);
        const isDisabled = currentDate < today;
        const isToday = currentDate.getTime() === today.getTime();
        const isSelected = isDateSelected(currentDate);
        const isInRange = isDateInRange(currentDate);
        const isRangeStart = selectedStartDate && currentDate.getTime() === selectedStartDate.getTime();
        const isRangeEnd = selectedEndDate && currentDate.getTime() === selectedEndDate.getTime();

        let classes = ['calendar-day'];
        if (isDisabled) classes.push('disabled');
        if (isToday) classes.push('today');
        if (isSelected) classes.push('selected');
        if (isInRange) classes.push('in-range');
        if (isRangeStart) classes.push('range-start');
        if (isRangeEnd) classes.push('range-end');

        html += `<button class="${classes.join(' ')}" data-date="${formatDate(currentDate)}" ${isDisabled ? 'disabled' : ''}>${day}</button>`;
    }

    html += '</div>';
    container.innerHTML = html;

    // Add click handlers
    container.querySelectorAll('.calendar-day:not(.disabled):not(.empty)').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            handleDateClick(new Date(btn.dataset.date + 'T00:00:00'));
        });
    });
}

function handleDateClick(date) {
    if (!selectedStartDate || (selectedStartDate && selectedEndDate) || date < selectedStartDate) {
        // Start new selection
        selectedStartDate = date;
        selectedEndDate = null;
        isSelectingEndDate = true;
    } else {
        // Complete selection
        selectedEndDate = date;
        isSelectingEndDate = false;
    }

    dateStart.value = selectedStartDate ? formatDate(selectedStartDate) : '';
    dateEnd.value = selectedEndDate ? formatDate(selectedEndDate) : '';
    
    renderCalendars();
}

function isDateSelected(date) {
    if (!selectedStartDate) return false;
    if (selectedStartDate && date.getTime() === selectedStartDate.getTime()) return true;
    if (selectedEndDate && date.getTime() === selectedEndDate.getTime()) return true;
    return false;
}

function isDateInRange(date) {
    if (!selectedStartDate || !selectedEndDate) return false;
    return date > selectedStartDate && date < selectedEndDate;
}

function updateDateDisplay() {
    if (selectedStartDate && selectedEndDate) {
        const startStr = selectedStartDate.toLocaleDateString(currentLanguage, { month: 'short', day: 'numeric' });
        const endStr = selectedEndDate.toLocaleDateString(currentLanguage, { month: 'short', day: 'numeric' });
        dateDisplayText.textContent = `${startStr} â€“ ${endStr}`;
    } else if (selectedStartDate) {
        const startStr = selectedStartDate.toLocaleDateString(currentLanguage, { month: 'short', day: 'numeric' });
        dateDisplayText.textContent = startStr;
    } else {
        dateDisplayText.textContent = t('select_dates');
    }
}

// ===== Language Functions =====
function applyLanguage(lang) {
    const t = translations[lang];
    
    // Update language button
    currentLangSpan.textContent = lang.toUpperCase();
    
    // Update flag
    const flags = { en: 'ðŸ‡¬ðŸ‡§', de: 'ðŸ‡©ðŸ‡ª', es: 'ðŸ‡ªðŸ‡¸', it: 'ðŸ‡®ðŸ‡¹' };
    currentFlagSpan.textContent = flags[lang] || 'ðŸ‡¬ðŸ‡§';
    
    // Update active state
    languageOptions.forEach(opt => {
        opt.classList.toggle('active', opt.dataset.lang === lang);
    });
    
    // Update all translatable elements
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (t[key]) {
            el.textContent = t[key];
        }
    });
    
    // Update placeholders
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.dataset.i18nPlaceholder;
        if (t[key]) {
            el.placeholder = t[key];
        }
    });
}

function t(key) {
    return translations[currentLanguage][key] || translations['en'][key] || key;
}

// ===== Helper Functions =====
function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function formatDisplayDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString(currentLanguage, { 
        weekday: 'short',
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
    });
}

function getCategoryEmoji(category) {
    const emojis = {
        'festivals': 'ðŸŽª',
        'concerts': 'ðŸŽµ',
        'markets': 'ðŸ›ï¸',
        'sports': 'âš½',
        'culture': 'ðŸŽ­',
        'nightlife': 'ðŸŒ™',
        'food': 'ðŸ½ï¸',
        'family': 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦',
        'outdoor': 'ðŸ”ï¸',
        'default': 'ðŸŽ‰'
    };
    return emojis[category.toLowerCase()] || emojis['default'];
}

function getGoogleMapsUrl(location, searchLocation) {
    const query = encodeURIComponent(`${location}, ${searchLocation}`);
    return `https://www.google.com/maps/search/?api=1&query=${query}`;
}

function getGoogleSearchUrl(eventTitle, location) {
    const query = encodeURIComponent(`${eventTitle} ${location} tickets`);
    return `https://www.google.com/search?q=${query}`;
}

function translateTime(time) {
    if (!time) return null;
    const timeLower = time.toLowerCase();
    if (timeLower === 'all day' || timeLower === 'ganztÃ¤gig') return t('all_day');
    if (timeLower === 'morning' || timeLower === 'vormittag') return t('morning');
    if (timeLower === 'afternoon' || timeLower === 'nachmittag') return t('afternoon');
    if (timeLower === 'evening' || timeLower === 'abend') return t('evening');
    if (timeLower === 'night' || timeLower === 'nacht') return t('night');
    return time;
}

function isValidUrl(string) {
    try {
        new URL(string);
        return true;
    } catch (_) {
        return false;
    }
}

function showLoading() {
    resultsSection.classList.add('visible');
    popularSection.style.display = 'none';
    loadingContainer.classList.add('visible');
    eventsGrid.style.display = 'none';
    activitiesGrid.style.display = 'none';
    activitiesDivider.classList.remove('visible');
    emptyState.classList.remove('visible');
}

function hideLoading() {
    loadingContainer.classList.remove('visible');
}

function showResults(events, activities, searchLocation) {
    eventsGrid.style.display = 'grid';
    eventsGrid.innerHTML = '';
    activitiesGrid.innerHTML = '';
    
    if (events.length === 0 && activities.length === 0) {
        eventsGrid.style.display = 'none';
        activitiesGrid.style.display = 'none';
        activitiesDivider.classList.remove('visible');
        emptyState.classList.add('visible');
        return;
    }
    
    emptyState.classList.remove('visible');
    
    // Render events
    events.forEach(event => {
        const card = createEventCard(event, searchLocation, false);
        eventsGrid.appendChild(card);
    });
    
    // Render activities
    if (activities.length > 0) {
        activitiesDivider.classList.add('visible');
        activitiesGrid.style.display = 'grid';
        
        activities.forEach(activity => {
            const card = createEventCard(activity, searchLocation, true);
            activitiesGrid.appendChild(card);
        });
    } else {
        activitiesDivider.classList.remove('visible');
        activitiesGrid.style.display = 'none';
    }
}

function createEventCard(event, searchLocation, isActivity) {
    const card = document.createElement('div');
    card.className = isActivity ? 'event-card activity-card' : 'event-card';
    
    const emoji = getCategoryEmoji(event.category);
    const mapsUrl = getGoogleMapsUrl(event.location, searchLocation);
    
    // Determine best link
    let link = getGoogleSearchUrl(event.title, searchLocation);
    let linkText = t('more_info');
    
    if (event.link && isValidUrl(event.link)) {
        link = event.link;
        linkText = t('tickets');
    }
    
    // Build date display
    let dateDisplay = '';
    if (event.dateStart) {
        dateDisplay = event.dateStart;
        if (event.dateEnd && event.dateEnd !== event.dateStart) {
            dateDisplay += ` â€“ ${event.dateEnd}`;
        }
    } else if (event.date) {
        dateDisplay = event.date;
    }
    
    // Time display
    const timeDisplay = translateTime(event.time);
    
    // Date section (only for events)
    let dateHtml = '';
    if (dateDisplay && !isActivity) {
        dateHtml = `
            <div class="event-card-date">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                ${dateDisplay}
            </div>
        `;
    }
    
    // Time section
    let timeHtml = '';
    if (timeDisplay && !isActivity) {
        timeHtml = `
            <div class="event-card-time">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                ${timeDisplay}
            </div>
        `;
    }
    
    // Price badge
    let priceBadgeHtml = '';
    if (event.priceEstimate) {
        priceBadgeHtml = `<span class="event-card-price-badge">${event.priceEstimate}</span>`;
    }

    // Duration badge
    let durationBadgeHtml = '';
    if (event.duration) {
        durationBadgeHtml = `
            <span class="event-card-duration">
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                ${event.duration}
            </span>
        `;
    }
    
    card.innerHTML = `
        <div class="event-card-image">
            ${emoji}
            ${priceBadgeHtml}
        </div>
        <div class="event-card-content">
            <div class="event-card-badges">
                <span class="event-card-category">${event.category}</span>
                ${durationBadgeHtml}
            </div>
            <h3 class="event-card-title">${event.title}</h3>
            <div class="event-card-meta">
                ${dateHtml}
                ${timeHtml}
            </div>
            <a href="${mapsUrl}" target="_blank" rel="noopener" class="event-card-location">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                ${event.location}
            </a>
            <p class="event-card-description">${event.description}</p>
            <div class="event-card-footer">
                <a href="${link}" target="_blank" rel="noopener" class="event-card-link">
                    ${linkText}
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M5 12h14"></path>
                        <path d="M12 5l7 7-7 7"></path>
                    </svg>
                </a>
            </div>
        </div>
    `;
    
    return card;
}

// ===== Main Search Function =====
async function performSearch() {
    const location = locationInput.value.trim();
    
    if (!location) {
        locationInput.focus();
        locationInput.style.outline = '2px solid var(--primary)';
        setTimeout(() => {
            locationInput.style.outline = '';
        }, 2000);
        return;
    }
    
    const radius = radiusSelect.value;
    const startDate = dateStart.value;
    const endDate = dateEnd.value;
    const category = currentCategory;
    
    // Update results header
    resultsTitle.textContent = `${t('events')} in ${location}`;
    resultsSubtitle.textContent = `${formatDisplayDate(startDate)} â€“ ${formatDisplayDate(endDate)}${radius > 0 ? ` â€¢ ${radius} km` : ''}`;
    
    showLoading();
    
    // Scroll to results
    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    try {
        const response = await fetch('/api/events', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                location,
                radius: parseInt(radius),
                startDate,
                endDate,
                category,
                priceFilter: currentPriceFilters,
                durationFilter: currentDurationFilters,
                language: currentLanguage
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to fetch events');
        }
        
        const data = await response.json();
        hideLoading();
        showResults(data.events || [], data.activities || [], location);
        
    } catch (error) {
        console.error('Search error:', error);
        hideLoading();
        
        eventsGrid.style.display = 'none';
        activitiesGrid.style.display = 'none';
        activitiesDivider.classList.remove('visible');
        emptyState.classList.add('visible');
        emptyState.querySelector('h3').textContent = 'Something went wrong';
        emptyState.querySelector('p').textContent = 'Please try again later';
    }
}
